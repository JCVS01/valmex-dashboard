<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VALMEX | Dashboard Asesor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js">
// ‚îÄ‚îÄ Cargar info del usuario activo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadUser() {
  try {
    const res  = await fetch('/me');
    if (!res.ok) { window.location.href = '/'; return; }
    const user = await res.json();
    document.getElementById('user-avatar').textContent = user.iniciales;
    document.getElementById('user-name').textContent   = user.nombre;

    // Si es solo "vista", ocultar pesta√±as de admin
    if (user.rol === 'vista') {
      // Vista solo puede ver Propuesta y Comparativa
      document.querySelectorAll('.nav-tab').forEach(btn => {
        const txt = btn.textContent.trim();
        if (txt === 'Configuraci√≥n' || txt === 'VALMEX Elite') {
          btn.style.display = 'none';
        }
      });
    }
  } catch(e) {
    window.location.href = '/';
  }
}
loadUser();

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js">
// ‚îÄ‚îÄ Cargar info del usuario activo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadUser() {
  try {
    const res  = await fetch('/me');
    if (!res.ok) { window.location.href = '/'; return; }
    const user = await res.json();
    document.getElementById('user-avatar').textContent = user.iniciales;
    document.getElementById('user-name').textContent   = user.nombre;

    // Si es solo "vista", ocultar pesta√±as de admin
    if (user.rol === 'vista') {
      // Vista solo puede ver Propuesta y Comparativa
      document.querySelectorAll('.nav-tab').forEach(btn => {
        const txt = btn.textContent.trim();
        if (txt === 'Configuraci√≥n' || txt === 'VALMEX Elite') {
          btn.style.display = 'none';
        }
      });
    }
  } catch(e) {
    window.location.href = '/';
  }
}
loadUser();

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
// ‚îÄ‚îÄ Cargar info del usuario activo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadUser() {
  try {
    const res  = await fetch('/me');
    if (!res.ok) { window.location.href = '/'; return; }
    const user = await res.json();
    document.getElementById('user-avatar').textContent = user.iniciales;
    document.getElementById('user-name').textContent   = user.nombre;

    // Si es solo "vista", ocultar pesta√±as de admin
    if (user.rol === 'vista') {
      // Vista solo puede ver Propuesta y Comparativa
      document.querySelectorAll('.nav-tab').forEach(btn => {
        const txt = btn.textContent.trim();
        if (txt === 'Configuraci√≥n' || txt === 'VALMEX Elite') {
          btn.style.display = 'none';
        }
      });
    }
  } catch(e) {
    window.location.href = '/';
  }
}
loadUser();

</script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>

:root {
  --navy:   #00205C;
  --sky:    #41BBC9;
  --blue:   #3DA5E0;
  --silver: #D3DDE6;
  --gray:   #5B6670;
  --white:  #FFFFFF;
  --bg:     #F0F3F7;

  /* Canvas fijo 1280√ó720 */
  --canvas-w: 1280px;
  --canvas-h: 720px;
  --gap:      12px;
  --edge-pad: 12px;
  --card-radius: 12px;

  /* Fila superior */
  --row-top-h: 328px;
  --comp-w: 190px;  --comp-h: var(--row-top-h);
  --hoy-w:  328px;  --hoy-h:  var(--row-top-h);
  --line-h: var(--row-top-h);

  /* Pies */
  --pie-w: 405px; --pie-h: 287px;

  /* Posiciones */
  --row-top-y: 85px;
  --comp-x: 9px;   --comp-y: var(--row-top-y);
  --hoy-x: calc(var(--comp-x) + var(--comp-w) + var(--gap));
  --hoy-y: var(--row-top-y);
  --line-x: calc(var(--hoy-x) + var(--hoy-w) + var(--gap));
  --line-y: var(--row-top-y);
  --pie1-x: 8px;
  --pie2-x: calc(var(--pie1-x) + var(--pie-w) + var(--gap));
  --pie3-x: calc(var(--pie2-x) + var(--pie-w) + var(--gap));
  --pies-y: calc(var(--row-top-y) + var(--row-top-h) + var(--gap));
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Montserrat', sans-serif;
  background: var(--bg);
  color: #1A2540;
}

/* ‚ïê‚ïê HEADER ‚ïê‚ïê */
.topbar {
  background: var(--navy);
  width: 100%;
  box-shadow: 0 2px 12px rgba(0,0,0,0.25);
}
.brand {
  max-width: 1700px;
  margin: 0 auto;
  padding: 0 40px;
  height: 90px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* Logo ‚Äî clickeable ‚Üí Presentaci√≥n */
.logo-btn {
  display: flex;
  align-items: center;
  cursor: pointer;
  background: none;
  border: none;
  padding: 8px 10px;
  border-radius: 10px;
  transition: background 0.18s;
  margin-right: 0;
  flex-shrink: 0;
  flex-shrink: 0;
}
.logo-btn:hover { background: rgba(255,255,255,0.10); }
.logo-svg { height: 52px; width: auto; }

/* Nav tabs */
.nav { display: flex; align-items: center; gap: 8px; flex: 1; justify-content: center; }
.nav-tab {
  color: rgba(255,255,255,0.75);
  background: transparent;
  border: 2px solid transparent;
  font-family: 'Montserrat', sans-serif;
  font-weight: 600;
  font-size: 18px;
  padding: 10px 28px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.nav-tab:hover { background: rgba(255,255,255,0.12); color: var(--white); }
.nav-tab.active { background: var(--white); color: var(--navy); font-weight: 700; }

.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.advisor-avatar {
  width: 38px; height: 38px; border-radius: 50%;
  background: var(--sky);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 800; color: var(--navy);
}
.advisor-name { font-size: 14px; color: rgba(255,255,255,0.85); font-weight: 500; }

/* ‚ïê‚ïê CONTENIDO ‚ïê‚ïê */
.container { max-width: 1700px; margin: 0 auto; padding: 32px 48px; }

/* P√°ginas */
.page { display: none; }
.page.active { display: block; }

/* ‚ïê‚ïê BOT√ìN DESCARGA (reutilizable) ‚ïê‚ïê */
.btn-dl {
  width: 40px; height: 40px;
  border-radius: 8px;
  background: var(--navy);
  border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  color: var(--white);
  transition: background 0.18s;
  text-decoration: none;
  flex-shrink: 0;
}
.btn-dl:hover { background: var(--sky); }

/* ‚ïê‚ïê PRESENTACI√ìN ‚ïê‚ïê */
.pres-card {
  background: var(--white);
  border-radius: 14px;
  border: 1px solid var(--silver);
  box-shadow: 0 4px 20px rgba(0,32,92,0.08);
  overflow: hidden;
  max-width: 1280px;
  margin: 0 auto;
}
.pres-header {
  background: #F7F9FC;
  border-bottom: 1px solid var(--silver);
  padding: 14px 22px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.pres-header h2 {
  font-size: 15px;
  font-weight: 600;
  color: var(--navy);
  font-family: 'Montserrat', sans-serif;
}
.pres-iframe-wrap {
  width: 100%;
  height: 78vh;
  overflow: hidden;
  background: var(--white);
  line-height: 0;
}
.pres-iframe-wrap iframe {
  width: 100%; height: 100%;
  border: none; display: block;
}

/* ‚ïê‚ïê PROPUESTA ‚ïê‚ïê */
.app-stage { overflow-x: auto; }

.prop-toolbar {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 10px;
  margin-bottom: 14px;
  max-width: var(--canvas-w);
  margin-inline: auto;
}
.prop-toolbar span { font-size: 12px; color: var(--gray); font-family: 'Inter', sans-serif; }

/* Canvas 1280√ó720 */
.propuesta-dashboard {
  position: relative;
  width: var(--canvas-w);
  height: var(--canvas-h);
  background: #fff;
  border-radius: 14px; overflow: hidden;
  border: 1px solid rgba(0,0,0,.08);
  box-shadow: 0 10px 30px rgba(0,0,0,.10);
  margin-inline: auto;
}

/* T√≠tulo overlay */
.prop-titlebar {
  position: absolute; left: 0; top: 0; right: 0;
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 12px 4px;
}
.prop-title-left { display: flex; align-items: center; gap: 12px; }
.prop-accent { width: 12px; height: 32px; background: var(--sky); border-radius: 3px; flex: 0 0 auto; }
.prop-title { font-size: 24px; font-weight: 900; letter-spacing: .3px; color: var(--navy); text-transform: uppercase; line-height: 32px; }
.prop-title-right { display: flex; align-items: center; }
.prop-rule {
  position: absolute; left: 12px; right: 12px; top: 50px;
  height: 3px; background: var(--navy); border-radius: 2px;
}

/* Board absoluto */
.board { position: absolute; left: 0; top: 0; width: var(--canvas-w); height: var(--canvas-h); }

/* Card base */
.card {
  position: absolute;
  background: #fff;
  border: 1px solid rgba(0,0,0,.08);
  border-radius: var(--card-radius);
  overflow: hidden;
  display: flex; flex-direction: column;
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
}
.card > header {
  background: var(--navy);
  color: #fff;
  padding: 8px 12px;
  font-weight: 800;
  font-size: 13px;
  letter-spacing: .2px;
  flex-shrink: 0;
}
.card > .body {
  padding: 10px;
  background: #fff;
  flex: 1 1 auto;
  display: flex;
}
.card canvas { width: 100% !important; height: 100% !important; display: block; }

/* Posiciones fila superior */
.comp  { left: var(--comp-x); top: var(--comp-y); width: var(--comp-w); height: var(--comp-h); }
.hoy   { left: var(--hoy-x);  top: var(--hoy-y);  width: var(--hoy-w);  height: var(--hoy-h); }
.linea { top: var(--line-y); height: var(--line-h); left: var(--line-x); right: var(--edge-pad); }

/* Posiciones pies */
.pie1 { left: var(--pie1-x); top: var(--pies-y); width: var(--pie-w); height: var(--pie-h); }
.pie2 { left: var(--pie2-x); top: var(--pies-y); width: var(--pie-w); height: var(--pie-h); }
.pie3 { left: var(--pie3-x); top: var(--pies-y); width: var(--pie-w); height: var(--pie-h); }

/* Rendimientos Hoy ‚Äî 2√ó3 */
.prop-rh-body { padding: 8px; align-items: stretch; }
.rh-grid {
  width: 100%; height: 100%;
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-auto-rows: 1fr;
  gap: 10px;
  align-content: start;
}
.rh-block {
  background: #fff;
  border: 1px solid rgba(0,0,0,.10);
  border-radius: 10px;
  padding: 10px;
  text-align: center;
  display: flex; flex-direction: column; justify-content: center;
}
.rh-pill {
  display: inline-block;
  background: var(--navy);
  color: #fff;
  padding: 6px 10px;
  border-radius: 8px;
  font-weight: 800;
  font-size: 12px;
  margin-bottom: 8px;
}
.rh-val { font-size: 22px; font-weight: 900; color: #111; }
.rh-val.pos { color: #16A34A; }
.rh-val.neg { color: #DC2626; }
.rh-val.flat { color: var(--sky); }

/* ‚ïê‚ïê CONFIGURACI√ìN ‚ïê‚ïê */
.config-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 20px; max-width: 840px; margin: 0 auto;
}
.cfg-card { background: var(--white); border: 1px solid var(--silver); border-radius: 12px; box-shadow: 0 2px 14px rgba(0,32,92,0.08); overflow: hidden; }
.cfg-header { background: var(--navy); padding: 13px 18px; }
.cfg-header h3 { font-size: 12px; font-weight: 700; color: var(--white); text-transform: uppercase; letter-spacing: 0.8px; }
.cfg-body { padding: 18px; }
.fg { margin-bottom: 13px; }
.fg label { display: block; font-size: 10.5px; font-weight: 600; color: var(--gray); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; font-family: 'Inter', sans-serif; }
.fg input, .fg select { width: 100%; padding: 8px 11px; border: 1px solid var(--silver); border-radius: 7px; font-size: 13px; font-family: 'Inter', sans-serif; color: #1A2540; background: var(--white); outline: none; transition: border-color 0.18s; }
.fg input:focus, .fg select:focus { border-color: var(--sky); }
.btn-primary { padding: 9px 22px; background: var(--navy); color: var(--white); border: none; border-radius: 7px; font-size: 12.5px; font-weight: 700; cursor: pointer; font-family: 'Montserrat', sans-serif; transition: background 0.18s; }
.btn-primary:hover { background: var(--sky); color: var(--navy); }

/* ‚ïê‚ïê COMPARATIVA ‚ïê‚ïê */
.comp-wrap { background: var(--white); border: 1px solid var(--silver); border-radius: 12px; box-shadow: 0 2px 14px rgba(0,32,92,0.08); overflow: hidden; max-width: 1000px; margin: 0 auto; }
.comp-wrap-header { background: var(--navy); padding: 13px 20px; }
.comp-wrap-header h3 { font-size: 12px; font-weight: 700; color: var(--white); text-transform: uppercase; letter-spacing: 0.8px; }
.comp-body { padding: 24px; height: 380px; position: relative; }

/* ‚ïê‚ïê ELITE ‚ïê‚ïê */
.elite-hero { max-width: 840px; margin: 0 auto; background: linear-gradient(130deg, var(--navy) 0%, #0A3580 100%); border-radius: 14px; padding: 40px 48px; display: flex; align-items: center; gap: 36px; box-shadow: 0 8px 32px rgba(0,32,92,0.22); }
.elite-icon { width: 68px; height: 68px; background: #C9A84C; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; flex-shrink: 0; }
.elite-text h2 { font-size: 22px; font-weight: 800; color: var(--white); margin-bottom: 6px; letter-spacing: 1px; }
.elite-text p  { font-size: 13px; color: rgba(255,255,255,0.76); font-family: 'Inter', sans-serif; line-height: 1.6; }
.elite-features { max-width: 840px; margin: 18px auto 0; display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; }
.ef-card { background: var(--white); border: 1px solid var(--silver); border-radius: 10px; padding: 18px; box-shadow: 0 2px 10px rgba(0,32,92,0.07); }
.ef-icon { width: 36px; height: 36px; border-radius: 8px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 18px; margin-bottom: 10px; }
.ef-card h4 { font-size: 11.5px; font-weight: 700; color: var(--navy); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
.ef-card p  { font-size: 11px; color: var(--gray); font-family: 'Inter', sans-serif; line-height: 1.5; }

@media (max-width: 1360px) {
  .container { padding: 20px; }
  .app-stage { overflow-x: auto; }
  .propuesta-dashboard { min-width: var(--canvas-w); }
}
@media print {
  .topbar, .prop-toolbar, .prop-title-right { display: none !important; }
  .propuesta-dashboard { box-shadow: none !important; border: none !important; }
  body { background: white !important; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="topbar">
  <div class="brand">

    <!-- Logo clickeable ‚Üí Presentaci√≥n -->
    <button class="logo-btn" onclick="showPage('presentacion')" title="Ver presentaci√≥n comercial">
      <img src="/VALMEX.png" class="logo-svg" alt="VALMEX Logo">
    </button>

    <!-- Nav -->
    <nav class="nav">
      <button class="nav-tab" onclick="showPage('configuracion',this)">Configuraci√≥n</button>
      <button class="nav-tab" onclick="showPage('propuesta',this)">Propuesta</button>
      <button class="nav-tab" onclick="showPage('comparativa',this)">Comparativa</button>
      <button class="nav-tab" onclick="showPage('elite',this)">VALMEX Elite</button>
    </nav>

    <div class="header-right">
      <div class="advisor-avatar">JC</div>
      <span class="advisor-name">Jos√© Carlos Villanueva</span>
    </div>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTENIDO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="container">

  <!-- ‚îÄ‚îÄ PRESENTACI√ìN ‚îÄ‚îÄ -->
  <div id="page-presentacion" class="page active">
    <div class="pres-card">
      <div class="pres-header">
        <h2>Presentaci√≥n</h2>
        <a href="/PC.pdf"
           download="Presentacion_Comercial_Valmex.pdf"
           class="btn-dl"
           title="Descargar presentaci√≥n">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
        </a>
      </div>
      <div class="pres-iframe-wrap">
        <iframe
          src="/PC.pdf#toolbar=0&navpanes=0&scrollbar=0&view=FitH"
          title="Presentaci√≥n Comercial Valmex">
        </iframe>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ PROPUESTA ‚îÄ‚îÄ -->
  <div id="page-propuesta" class="page">
    <div class="app-stage">
      <div class="prop-toolbar">
        <span>Exportar como PDF ¬∑ Hoja carta horizontal</span>
        <button class="btn-dl" id="btn-export-pdf" title="Descargar PDF">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
        </button>
      </div>

      <div class="propuesta-dashboard" id="propuesta-dashboard">
        <div class="prop-titlebar">
          <div class="prop-title-left">
            <div class="prop-accent"></div>
            <span class="prop-title">Estrategia del Portafolio</span>
          </div>
          <div class="prop-title-right">
            <svg height="26" viewBox="0 0 160 32" fill="none" xmlns="http://www.w3.org/2000/svg">
              <polygon points="0,28 2.5,28 10,8 7.5,8" fill="#0b2a5a"/>
              <polygon points="22,28 24.5,28 17,8 14.5,8" fill="#0b2a5a"/>
              <polygon points="7.5,8 10,8 15,20 12.5,20" fill="#0b2a5a"/>
              <polygon points="14.5,8 17,8 12,20 9.5,20" fill="#0b2a5a"/>
              <polygon points="9.5,20 15,20 12.25,26" fill="#41BBC9"/>
              <rect x="31" y="4" width="1.5" height="24" rx="0.75" fill="#41BBC9"/>
              <text x="38" y="14" font-family="Montserrat,sans-serif" font-weight="700" font-size="9.5" letter-spacing="1.2" fill="#0b2a5a">VALORES</text>
              <text x="38" y="27" font-family="Montserrat,sans-serif" font-weight="700" font-size="9.5" letter-spacing="1.2" fill="#0b2a5a">MEXICANOS</text>
            </svg>
          </div>
        </div>
        <div class="prop-rule"></div>

        <div class="board">
          <div class="card comp">
            <header>Composici√≥n</header>
            <div class="body" style="padding:8px;"><canvas id="chart-composicion"></canvas></div>
          </div>

          <div class="card hoy">
            <header>Rendimientos Hoy</header>
            <div class="body prop-rh-body">
              <div class="rh-grid">
                <div class="rh-block"><span class="rh-pill">Propuesta</span><span class="rh-val pos">+0.48%</span></div>
                <div class="rh-block"><span class="rh-pill">Benchmark</span><span class="rh-val pos">+0.31%</span></div>
                <div class="rh-block"><span class="rh-pill">RV M√©xico</span><span class="rh-val neg">‚àí0.12%</span></div>
                <div class="rh-block"><span class="rh-pill">RV USA</span><span class="rh-val pos">+0.73%</span></div>
                <div class="rh-block"><span class="rh-pill">Deuda MX</span><span class="rh-val flat">+0.05%</span></div>
                <div class="rh-block"><span class="rh-pill">Alternat.</span><span class="rh-val pos">+0.19%</span></div>
              </div>
            </div>
          </div>

          <div class="card linea">
            <header>Rendimientos Mensuales ‚Äî Perfiles a trav√©s del Tiempo</header>
            <div class="body" style="padding:8px;"><canvas id="chart-lineas"></canvas></div>
          </div>

          <div class="card pie1">
            <header>Clase de Activos</header>
            <div class="body" style="padding:6px;height:100%;"><canvas id="chart-clase"></canvas></div>
          </div>
          <div class="card pie2">
            <header>Exposici√≥n Geogr√°fica RV</header>
            <div class="body" style="padding:6px;height:100%;"><canvas id="chart-geo"></canvas></div>
          </div>
          <div class="card pie3">
            <header>Exposici√≥n Sectorial RV</header>
            <div class="body" style="padding:6px;height:100%;"><canvas id="chart-sector"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ CONFIGURACI√ìN ‚îÄ‚îÄ -->
  <div id="page-configuracion" class="page">
    <div class="config-grid">
      <div class="cfg-card">
        <div class="cfg-header"><h3>Datos del Cliente</h3></div>
        <div class="cfg-body">
          <div class="fg"><label>Nombre completo</label><input type="text" placeholder="Ej. Mar√≠a Garc√≠a L√≥pez"></div>
          <div class="fg"><label>Perfil de riesgo</label>
            <select><option>Conservador</option><option>Moderado</option><option selected>Balanceado</option><option>Crecimiento</option><option>Agresivo</option></select>
          </div>
          <div class="fg"><label>Monto del portafolio (MXN)</label><input type="number" placeholder="5,000,000"></div>
          <button class="btn-primary">Guardar cliente</button>
        </div>
      </div>
      <div class="cfg-card">
        <div class="cfg-header"><h3>Par√°metros del Portafolio</h3></div>
        <div class="cfg-body">
          <div class="fg"><label>Benchmark</label>
            <select><option>CETES 28d</option><option selected>IPC + CETES</option><option>S&P 500</option></select>
          </div>
          <div class="fg"><label>Horizonte de inversi√≥n</label>
            <select><option>1 a√±o</option><option selected>3 a√±os</option><option>5 a√±os</option><option>10+ a√±os</option></select>
          </div>
          <div class="fg"><label>Moneda de reporte</label>
            <select><option selected>MXN</option><option>USD</option></select>
          </div>
          <button class="btn-primary">Aplicar par√°metros</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ COMPARATIVA ‚îÄ‚îÄ -->
  <div id="page-comparativa" class="page">
    <div class="comp-wrap">
      <div class="comp-wrap-header"><h3>Comparativa de Portafolios</h3></div>
      <div class="comp-body"><canvas id="chart-comparativa"></canvas></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ ELITE ‚îÄ‚îÄ -->
  <div id="page-elite" class="page">
    <div class="elite-hero">
      <div class="elite-icon">‚≠ê</div>
      <div class="elite-text">
        <h2>VALMEX ELITE</h2>
        <p>Acceso exclusivo a estrategias de inversi√≥n de alto impacto, an√°lisis cuantitativo avanzado y reporter√≠a personalizada para patrimonios significativos.</p>
      </div>
    </div>
    <div class="elite-features">
      <div class="ef-card"><div class="ef-icon">üìä</div><h4>An√°lisis Cuantitativo</h4><p>Modelos propietarios con datos de Morningstar y Bloomberg para optimizaci√≥n de portafolios.</p></div>
      <div class="ef-card"><div class="ef-icon">üåê</div><h4>Acceso Global</h4><p>M√°s de 10,000 instrumentos en 45 mercados internacionales.</p></div>
      <div class="ef-card"><div class="ef-icon">üìÑ</div><h4>Reporter√≠a Premium</h4><p>Presentaciones ejecutivas automatizadas con tu branding y datos en tiempo real.</p></div>
    </div>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
const PAGES = ['presentacion','propuesta','configuracion','comparativa','elite'];

function showPage(name, el) {
  PAGES.forEach(id => document.getElementById('page-'+id).classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
  if (name === 'propuesta') setTimeout(() => Object.values(charts).forEach(c => c && c.resize()), 60);
}

Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.font.size   = 11;
Chart.defaults.color       = '#5B6670';

const PALETTE = ['#00205C','#41BBC9','#3DA5E0','#22C55E','#8B5CF6','#EF4444','#F59E0B'];
const charts  = {};

charts.comp = new Chart(document.getElementById('chart-composicion'), {
  type: 'bar',
  data: {
    labels: ['Deuda MX','RV MX','RV USA','Intl Desa.','Alternat.','Liquidez'],
    datasets: [{ data:[35,20,18,12,10,5], backgroundColor:'#00205C', borderRadius:0, barPercentage:0.62 }]
  },
  options: {
    indexAxis:'y', responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{display:false} },
    layout:{ padding:{right:38} },
    scales:{
      x:{ display:false, max:44, grid:{display:false} },
      y:{ grid:{display:false}, ticks:{font:{size:10,weight:'700'},color:'#00205C'}, border:{display:false} }
    }
  },
  plugins:[{ id:'pct', afterDatasetsDraw(chart){
    const {ctx,scales:{x,y}} = chart;
    ctx.save();
    chart.data.datasets[0].data.forEach((val,i)=>{
      const bar = chart.getDatasetMeta(0).data[i];
      ctx.fillStyle='#00205C'; ctx.font='bold 10.5px Inter,sans-serif';
      ctx.textBaseline='middle';
      ctx.fillText(val+'%', x.getPixelForValue(val)+4, bar.y);
    });
    ctx.restore();
  }}]
});

charts.linea = new Chart(document.getElementById('chart-lineas'), {
  type:'line',
  data:{
    labels:['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
    datasets:[
      { label:'Propuesta', data:[0,1.2,2.8,2.1,3.5,5.0,4.6,6.2,7.8,7.1,9.0,10.4],
        borderColor:'#00205C', backgroundColor:'rgba(0,32,92,0.06)',
        borderWidth:2.5, pointRadius:3, tension:0.4, fill:true },
      { label:'Benchmark', data:[0,0.8,1.6,1.2,2.0,3.1,2.8,3.9,4.7,4.2,5.6,6.3],
        borderColor:'#41BBC9', backgroundColor:'transparent',
        borderWidth:2, pointRadius:3, tension:0.4, borderDash:[5,3] }
    ]
  },
  options:{
    responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{ position:'top', align:'end', labels:{ boxWidth:11, font:{size:10}, padding:10 } } },
    scales:{
      x:{ grid:{color:'rgba(0,0,0,0.04)'}, ticks:{font:{size:9.5}}, border:{display:false} },
      y:{ grid:{color:'rgba(0,0,0,0.04)'}, ticks:{font:{size:9.5}, callback:v=>v+'%'}, border:{display:false} }
    }
  }
});

function makeDoughnut(id, labels, data) {
  return new Chart(document.getElementById(id), {
    type:'doughnut',
    data:{ labels, datasets:[{ data, backgroundColor:PALETTE.slice(0,data.length), borderWidth:1.5, borderColor:'#fff', hoverOffset:5 }] },
    options:{ responsive:true, maintainAspectRatio:false, cutout:'55%',
      plugins:{ legend:{ position:'right', labels:{ boxWidth:9, font:{size:9.5}, padding:7, color:'#00205C' } } } }
  });
}

charts.clase  = makeDoughnut('chart-clase',  ['Deuda MX','RV MX','RV USA','Intl Desa.','Alternat.','Liquidez'],[35,20,18,12,10,5]);
charts.geo    = makeDoughnut('chart-geo',    ['M√©xico','EUA','Europa','Asia','Latam'],[28,35,18,11,8]);
charts.sector = makeDoughnut('chart-sector', ['Financiero','Tecnolog√≠a','Consumo','Salud','Industrial','Energ√≠a'],[22,25,18,14,12,9]);

charts.comp2 = new Chart(document.getElementById('chart-comparativa'), {
  type:'bar',
  data:{
    labels:['Conservador','Moderado','Balanceado','Crecimiento','Agresivo'],
    datasets:[
      { label:'Rendimiento 1A (%)', data:[4.2,6.8,9.4,12.1,15.7], backgroundColor:'#00205C', borderRadius:4, barPercentage:0.5 },
      { label:'Benchmark 1A (%)',   data:[3.1,5.2,7.6,9.8,12.4],  backgroundColor:'#41BBC9', borderRadius:4, barPercentage:0.5 }
    ]
  },
  options:{ responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{ position:'top', labels:{ font:{size:12}, padding:14 } } },
    scales:{
      x:{ grid:{display:false}, border:{display:false} },
      y:{ grid:{color:'rgba(0,0,0,0.05)'}, border:{display:false}, ticks:{callback:v=>v+'%'} }
    }
  }
});

document.getElementById('btn-export-pdf').addEventListener('click', async () => {
  const {jsPDF} = window.jspdf;
  const dash  = document.getElementById('propuesta-dashboard');
  const badge = dash.querySelector('.prop-title-right');
  if(badge) badge.style.visibility='hidden';
  const canvas = await html2canvas(dash,{scale:2,useCORS:true,backgroundColor:'#fff'});
  if(badge) badge.style.visibility='visible';
  const img = canvas.toDataURL('image/png');
  const pdf = new jsPDF({orientation:'landscape',unit:'mm',format:'letter'});
  const pw=pdf.internal.pageSize.getWidth(), ph=pdf.internal.pageSize.getHeight(), m=8;
  const iw=pw-m*2, ih=Math.min((canvas.height/canvas.width)*iw, ph-m*2);
  pdf.addImage(img,'PNG',m,m,iw,ih);
  pdf.save('propuesta_valmex.pdf');
});

// ‚îÄ‚îÄ Cargar info del usuario activo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadUser() {
  try {
    const res  = await fetch('/me');
    if (!res.ok) { window.location.href = '/'; return; }
    const user = await res.json();
    document.getElementById('user-avatar').textContent = user.iniciales;
    document.getElementById('user-name').textContent   = user.nombre;

    // Si es solo "vista", ocultar pesta√±as de admin
    if (user.rol === 'vista') {
      // Vista solo puede ver Propuesta y Comparativa
      document.querySelectorAll('.nav-tab').forEach(btn => {
        const txt = btn.textContent.trim();
        if (txt === 'Configuraci√≥n' || txt === 'VALMEX Elite') {
          btn.style.display = 'none';
        }
      });
    }
  } catch(e) {
    window.location.href = '/';
  }
}
loadUser();

</script>
</body>
</html>
